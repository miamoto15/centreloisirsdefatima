name: Auto-merge approved PRs

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    if: >
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Auto-merge pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_MERGE_PAT }}
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            // VÃ©rifie que la PR est mergeable
            const { data: prData } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr.number,
            });

            if (!prData.mergeable) {
              core.setFailed('PR non mergeable (conflits ou autre).');
            } else {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                merge_method: 'squash', // ou 'merge' ou 'rebase'
              });
            }
